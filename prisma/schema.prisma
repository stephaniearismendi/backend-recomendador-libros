generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int              @id @default(autoincrement())
  username  String           @unique
  email     String           @unique
  password  String
  name      String?
  bio       String?
  avatar    String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  reviews   Review[]
  favorites Favorite[]
  sessions  ReadingSession[]
  posts     Post[]
  postComments PostComment[]
  likes     Like[]
  chapterComments ChapterComment[]
  stories   Story[]

  following Follow[] @relation("UserFollows")
  followers Follow[] @relation("UserFollowedBy")
}

model Book {
  id          String           @id
  title       String
  author      String
  imageUrl    String?
  description String?
  rating      String?
  category    String?
  reviews     Review[]
  favorites   Favorite[]
  sessions    ReadingSession[]
}

model Favorite {
  user   User   @relation(fields: [userId], references: [id])
  userId Int
  book   Book   @relation(fields: [bookId], references: [id])
  bookId String

  @@id([userId, bookId])
}

model Review {
  id      Int    @id @default(autoincrement())
  content String
  rating  Int
  user    User   @relation(fields: [userId], references: [id])
  userId  Int
  book    Book   @relation(fields: [bookId], references: [id])
  bookId  String
}

model ReadingSession {
  id       Int    @id @default(autoincrement())
  progress Int
  duration Int
  user     User   @relation(fields: [userId], references: [id])
  userId   Int
  book     Book   @relation(fields: [bookId], references: [id])
  bookId   String
}

model Post {
  id         String    @id @default(cuid())
  userId     Int
  text       String?
  bookTitle  String?
  bookAuthor String?
  bookCover  String?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id])
  likes      Like[]
  comments   PostComment[]
}

model PostComment {
  id         String   @id @default(cuid())
  postId     String
  userId     Int
  text       String
  createdAt  DateTime @default(now())
  post       Post     @relation(fields: [postId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
}

model Like {
  userId    Int
  postId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@id([userId, postId])
}

model Club {
  id        String        @id @default(cuid())
  name      String
  cover     String?
  createdAt DateTime      @default(now())
  members   ClubMember[]  @relation("ClubMembers")
  chapters  ClubChapter[] @relation("ClubChapters")
}

model ClubMember {
  userId   Int
  clubId   String
  joinedAt DateTime @default(now())
  club     Club     @relation("ClubMembers", fields: [clubId], references: [id])

  @@id([userId, clubId])
}

model ClubChapter {
  id        String        @id @default(cuid())
  clubId    String
  chapter   Int
  title     String?
  createdAt DateTime      @default(now())
  club      Club          @relation("ClubChapters", fields: [clubId], references: [id])
  comments  ChapterComment[]

  @@unique([clubId, chapter])
  @@index([clubId, chapter])
}

model ChapterComment {
  id         String   @id @default(cuid())
  chapterId  String
  userId     Int
  text       String
  createdAt  DateTime @default(now())

  chapter ClubChapter @relation(fields: [chapterId], references: [id])
  user    User        @relation(fields: [userId], references: [id])

  @@index([chapterId, createdAt])
}

model Follow {
  followerId  Int
  followingId Int
  createdAt   DateTime @default(now())

  follower  User @relation("UserFollows", fields: [followerId], references: [id])
  following User @relation("UserFollowedBy", fields: [followingId], references: [id])

  @@id([followerId, followingId])
}

model Story {
  id        String   @id @default(cuid())
  userId    Int
  content   String   // Texto de la historia
  bookTitle String?  // Libro relacionado (opcional)
  bookCover String?  // Portada del libro (opcional)
  createdAt DateTime @default(now())
  expiresAt DateTime // Las historias expiran despu√©s de 24 horas
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([expiresAt])
}
